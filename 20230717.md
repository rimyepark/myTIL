## 트랜잭션

- 트랜잭션(Transaction)이란 

트랜잭션(Transaction)은 작업의 완전성을 보장해주기 위해 사용되는 개념이다. 특정한 작업을 전부 처리하거나, 전부 실패하게 만들어 데이터의 일관성을 보장해주는 기능이다.
    
트랜잭션(Transaction)을 사용하는 대표적인 이유는 작업의 단위를 하나의 쿼리에 종속하는 것이 아닌, 여러개의 작업(쿼리)을 묶어 하나의 작업 단위로 그룹화하여 처리하는 작업을 뜻한다.

- 트랜잭션을 왜 사용해야하는가?

트랜잭션(Transaction)을 이용한다면 사용자가 항상 프로그램 실행을 완료하도록 구성하고, 만약 실행을 중단할 만한 치명적인 오류가 발생하더라도, DB에 피해가 가지않아 더욱 안전하게 구성할 수 있게 된다.

- 트랜잭션의 특징(ACID)


1. 원자성(Atomicity)

 트랜잭션 내에서 실행되는 명령들을 하나의 묶음으로 처리하여, 내부에서 실행된 명령들이 **전부 성공**하거나, 아니면 **모두 실패**해야한다는 특징. 트랜잭션에서 실행되는 쿼리마다 하나의 작업 단위로 보지않고, **여러개의 작업들을 묶어 하나의 작업단위**로 보게된다.

2. 일관성(Consistency)

트랜잭션 내부에서 처리되는 **데이터의 일관성**을 **유지**해야하는 특징. 만약 작업이 **성공**할 경우 **아무런 문제가 발생하지 않고**, **실패**하더라도 작업을 진행하던 도중 **실패한 상태로 데이터를 방치하지 않는 특징**. 만약 **일관성**이 지켜지지 않는다면 트랜잭션을 이용하더라도 **언제 데이터가 파손될 지** 모르는 불안감을 가진 체 작업을 해야할 것 이다. 🥲


3. **격리성(Isolation)**

트랜잭션의 경우 실행 전이나 실행 후의 데이터를 외부에서 참조할 수 있지만, **트랜잭션을 수행하는 중간 상태를 보거나 변경할 수 없도록 구성**하는 특징. 격리성(Isolation)의 경우, MySQL에서는 사용중인 DB 오브젝트에 락(Lock)을 걸어 격리성을 구현하게 된다. 여기서 락(Lock)을 건 상태는 DB에 접속한 **또다른 클라이언트**가 해당하는 DB 오브젝트를 **읽거나, 사용**할 수 없도록 만든다는 개념이다. 

→ 격리성이란 특징에서 **동시성(Concurrency)**과 **격리 수준(Isolation Level)**라는 개념이 나타나게되었다.


* 동시성(Concurrency)

 **여러명**의 클라이언트가 **하나의 데이터**를 동시에 **사용**및 **공유** 하는 것을 뜻한다.

```예시
📌 계좌이체를 하기 위해, 2개의 계좌이체가 발생한다고 가정하겠다.

1. 1️⃣  트랜잭션에서 A 계좌에서 '천원을 차감'하여 `10,000` → `9,000`으로 수정하였습니다.
2. 2️⃣  트랜잭션에서 '수정된 데이터를 바탕'으로 A 계좌에서 천원을 차감하여 `9,000` → `8,000`으로 수정하였습니다.
3. 1️⃣  트랜잭션에서 에러가 발생하여, 트랜잭션을 `ROLLBACK`하게 되었습니다.
4. 2️⃣  트랜잭션에서 트랜잭션을 `COMMIT` 하게 되었습니다.
</aside>

예시의 2️⃣  트랜잭션은 '수정 중인 1️⃣  트랜잭션'의 잘못된 데이터를 참조하는 문제가 발생하였습니다. 잘못된 데이터를 바탕으로 '2️⃣  트랜잭션'이 비즈니스로직을 수행하여 `9,000`이 되어야할 계좌의 잔고가 `8,000`이 되었습니다.

위와 같이, 하나의 자원을 여러명이 사용하여 발생하는 문제를 [동시성 문제(Concurrency Issues)]라고 말한다.
```

그렇다면, **동시성 문제**가 발생하지 않도록 하려면 어떻게 해야할까?

자원을 사용하는 **하나의 클라이언트**만 해당 자원을 **점유**할 수 있도록 하여, 다른 사용자가 접근할 수 없도록 만들어 **자원을 공유하는 원인을 제거**하면 된다. 이것을 [자원 잠금(Resource Locking)]라고 부르며, 락(Lock)이라는 개념이 나오게 된 것 이다.

* 락(Lock)

 **동시성을 제어**하기 위해 사용하는 기능. 해당하는 **데이터를 점유**하여 다른 트랜잭션의 접근을 막아 **동시성**과 **일관성**의 **균형**을 맞추기 위해 사용한다.

**하나의 데이터**를 **여러 사용자**들이 **동시에 변경**하려고 할 때, **락**이 존재하지 않다면, 한번에 여러번의 수정이 발생하게되고, 최종 수정된 **결과값을 인지할 수 없게 되는 상황**으로 인해 데이터베이스의 일관성이 깨지게 된다. 이런 상황을 방지하기 위해 데이터베이스에서는 락(Lock)이라는 기능을 지원한다.

4.  지속성(Durability)

 트랜잭션을 **성공적으로 수행**하면 수정된 데이터를 시스템에 **영구적으로 적용**하는 특징이다. 트랜잭션의 **중간 결과**가 아니라 **완성된 결과**만 **저장**하여 데이터베이스에 이상이 생기더라도 **자동 복구**할 수 있는 특성을 가지고 있다.


어플리케이션이 트랜잭션을 완료한 이후, DB에 `COMMIT`을 요청하였지만 변경사항이 반영되기 전에 DB가 비정상 종료될 경우, **DB가 재시작 될 때 트랜잭션의 변경 사항을 다시 반영**하게 되는데, 이러한 특징을 지속성(Durability)이라고 한다.